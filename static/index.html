<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†…ç½‘æµ‹é€Ÿå·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #34495e;
            font-size: 1.3em;
        }
        
        button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-line;
            display: none;
        }
        
        .download-result {
            background: #e8f5e8;
            border-left: 4px solid #27ae60;
            color: #2c3e50;
        }
        
        .upload-result {
            background: #e8f4fd;
            border-left: 4px solid #3498db;
            color: #2c3e50;
        }
        
        .ping-result {
            background: #fff3cd;
            border-left: 4px solid #f39c12;
            color: #2c3e50;
        }
        
        .speed-test-result {
            background: #f8d7da;
            border-left: 4px solid #e74c3c;
            color: #2c3e50;
        }
        
        .status {
            text-align: center;
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ å†…ç½‘æµ‹é€Ÿå·¥å…·</h1>
        
        <div class="test-section">
            <h3>ğŸ“¥ ä¸‹è½½é€Ÿåº¦æµ‹è¯•</h3>
            <button id="downloadBtn" onclick="testDownload()">å¼€å§‹ä¸‹è½½æµ‹è¯•</button>
            <div id="downloadResult" class="result download-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“¤ ä¸Šä¼ é€Ÿåº¦æµ‹è¯•</h3>
            <button id="uploadBtn" onclick="testUpload()">å¼€å§‹ä¸Šä¼ æµ‹è¯•</button>
            <div id="uploadResult" class="result upload-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ å»¶è¿Ÿæµ‹è¯•</h3>
            <button id="pingBtn" onclick="testPing()">å¼€å§‹å»¶è¿Ÿæµ‹è¯•</button>
            <div id="pingResult" class="result ping-result"></div>
        </div>

        <div class="test-section">
            <h3>âš¡ ç»¼åˆæµ‹é€Ÿ</h3>
            <button id="speedTestBtn" onclick="runSpeedTest()">å¼€å§‹ç»¼åˆæµ‹è¯•</button>
            <div id="speedTestResult" class="result speed-test-result"></div>
        </div>
    </div>

    <script>
        async function testDownload() {
            const btn = document.getElementById('downloadBtn');
            const result = document.getElementById('downloadResult');

            btn.disabled = true;
            result.style.display = 'block';
            result.innerHTML = 'æ­£åœ¨å‡†å¤‡æµ‹è¯•...';

            try {
                // æµ‹è¯•ä¸åŒå¤§å°çš„æ•°æ®åŒ…
                const testConfigs = [
                    { size: 0.5, count: 50, name: 'å°åŒ…' },
                    { size: 1, count: 30, name: 'ä¸­å°åŒ…' },
                    { size: 5, count: 20, name: 'ä¸­åŒ…' },
                    { size: 10, count: 15, name: 'å¤§åŒ…' },
                    { size: 50, count: 10, name: 'è¶…å¤§åŒ…' }
                ];

                const allResults = [];

                for (const config of testConfigs) {
                    result.innerHTML = `ä¸‹è½½æµ‹è¯•: ${config.name} (${config.size}MB) - æ­£åœ¨æµ‹è¯• ${config.count} æ¬¡...`;
                    const speeds = [];

                    for (let i = 0; i < config.count; i++) {
                        const startTime = performance.now();

                        // å‘èµ·ä¸‹è½½è¯·æ±‚
                        const response = await fetch(`/api/download?size=${config.size}MB&t=${Date.now()}&r=${Math.random()}`, {
                            cache: 'no-cache'
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        // è·å–å“åº”ä½“
                        const reader = response.body.getReader();
                        let totalBytes = 0;

                        // æµå¼è¯»å–æ•°æ®
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            totalBytes += value.length;
                        }

                        const endTime = performance.now();
                        const actualTime = (endTime - startTime) / 1000;
                        const speed = totalBytes / 1024 / 1024 / actualTime;
                        speeds.push(speed);

                        // çŸ­æš‚ä¼‘æ¯
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }

                    const avgSpeed = speeds.reduce((a, b) => a + b, 0) / speeds.length;
                    const minSpeed = Math.min(...speeds);
                    const maxSpeed = Math.max(...speeds);
                    
                    allResults.push({ 
                        size: config.size, 
                        name: config.name,
                        speed: avgSpeed, 
                        min: minSpeed, 
                        max: maxSpeed,
                        count: config.count
                    });

                    result.innerHTML = `ä¸‹è½½æµ‹è¯•: ${config.name} (${config.size}MB) - å¹³å‡ ${avgSpeed.toFixed(2)} MB/s (${config.count}æ¬¡)`;
                }

                // åˆ†æç»“æœ
                let resultText = 'ä¸‹è½½é€Ÿåº¦æµ‹è¯•ç»“æœ:\n\n';
                
                allResults.forEach(r => {
                    resultText += `${r.name} (${r.size}MB): ${r.speed.toFixed(2)} MB/s (${r.count}æ¬¡æµ‹è¯•)\n`;
                    resultText += `  èŒƒå›´: ${r.min.toFixed(2)} - ${r.max.toFixed(2)} MB/s\n\n`;
                });

                // è®¡ç®—å°åŒ…å’Œå¤§åŒ…çš„å¹³å‡é€Ÿåº¦
                const smallPackets = allResults.filter(r => r.size <= 1);
                const largePackets = allResults.filter(r => r.size >= 10);

                if (smallPackets.length > 0) {
                    const smallAvg = smallPackets.reduce((sum, r) => sum + r.speed, 0) / smallPackets.length;
                    resultText += `å°åŒ…å¹³å‡é€Ÿåº¦ (â‰¤1MB): ${smallAvg.toFixed(2)} MB/s\n`;
                }

                if (largePackets.length > 0) {
                    const largeAvg = largePackets.reduce((sum, r) => sum + r.speed, 0) / largePackets.length;
                    resultText += `å¤§åŒ…å¹³å‡é€Ÿåº¦ (â‰¥10MB): ${largeAvg.toFixed(2)} MB/s\n`;
                }

                if (smallPackets.length > 0 && largePackets.length > 0) {
                    const smallAvg = smallPackets.reduce((sum, r) => sum + r.speed, 0) / smallPackets.length;
                    const largeAvg = largePackets.reduce((sum, r) => sum + r.speed, 0) / largePackets.length;
                    const difference = ((largeAvg - smallAvg) / smallAvg * 100).toFixed(1);
                    resultText += `æ€§èƒ½å·®å¼‚: ${difference}% (å¤§åŒ…æ¯”å°åŒ…å¿«)\n`;
                }

                result.innerHTML = resultText.replace(/\n/g, '<br>');

            } catch (error) {
                result.innerHTML = `æµ‹è¯•å¤±è´¥: ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'å¼€å§‹ä¸‹è½½æµ‹è¯•';
            }
        }

        async function testUpload() {
            const btn = document.getElementById('uploadBtn');
            const result = document.getElementById('uploadResult');

            btn.disabled = true;
            result.style.display = 'block';
            result.innerHTML = 'æ­£åœ¨å‡†å¤‡æµ‹è¯•...';

            try {
                const startTime = performance.now();

                // ç”Ÿæˆæµ‹è¯•æ•°æ® (1MB)
                const testData = new Uint8Array(1024 * 1024);
                for (let i = 0; i < testData.length; i++) {
                    testData[i] = Math.floor(Math.random() * 256);
                }

                // å‘é€æ•°æ®
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/octet-stream',
                    },
                    body: testData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const endTime = performance.now();
                const actualTime = (endTime - startTime) / 1000;
                const speed = (1024 * 1024) / 1024 / 1024 / actualTime;

                result.innerHTML = `ä¸Šä¼ é€Ÿåº¦: ${speed.toFixed(2)} MB/s (æµ‹è¯•æ—¶é•¿: ${actualTime.toFixed(1)}ç§’)`;

            } catch (error) {
                result.innerHTML = `æµ‹è¯•å¤±è´¥: ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'å¼€å§‹ä¸Šä¼ æµ‹è¯•';
            }
        }

        async function testPing() {
            const btn = document.getElementById('pingBtn');
            const result = document.getElementById('pingResult');
            
            btn.disabled = true;
            result.style.display = 'block';
            result.innerHTML = 'æ­£åœ¨æµ‹è¯•å»¶è¿Ÿ...';
            
            try {
                const latencies = [];
                const testCount = 10; // æµ‹è¯•10æ¬¡
                
                for (let i = 0; i < testCount; i++) {
                    const startTime = performance.now();
                    const response = await fetch('/api/ping?t=' + Date.now());
                    const endTime = performance.now();
                    
                    if (response.ok) {
                        const latency = Math.round(endTime - startTime);
                        latencies.push(latency);
                        result.innerHTML = `å»¶è¿Ÿæµ‹è¯•: ${i + 1}/${testCount} - ${latency}ms`;
                    }
                    
                    // çŸ­æš‚ä¼‘æ¯
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // è®¡ç®—ç»Ÿè®¡ç»“æœ
                const avgLatency = latencies.reduce((a, b) => a + b, 0) / latencies.length;
                const minLatency = Math.min(...latencies);
                const maxLatency = Math.max(...latencies);
                
                // è®¡ç®—æŠ–åŠ¨ (è¿ç»­ä¸¤æ¬¡å»¶è¿Ÿå·®çš„å¹³å‡å€¼)
                let jitter = 0;
                if (latencies.length > 1) {
                    let totalDiff = 0;
                    for (let i = 1; i < latencies.length; i++) {
                        totalDiff += Math.abs(latencies[i] - latencies[i-1]);
                    }
                    jitter = totalDiff / (latencies.length - 1);
                }
                
                result.innerHTML = `å»¶è¿Ÿ: å¹³å‡ ${avgLatency.toFixed(1)}ms, æœ€å° ${minLatency}ms, æœ€å¤§ ${maxLatency}ms, æŠ–åŠ¨ ${jitter.toFixed(1)}ms`;
                
            } catch (error) {
                result.innerHTML = `æµ‹è¯•å¤±è´¥: ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'å¼€å§‹å»¶è¿Ÿæµ‹è¯•';
            }
        }

        async function runSpeedTest() {
            const btn = document.getElementById('speedTestBtn');
            const result = document.getElementById('speedTestResult');
            
            btn.disabled = true;
            result.style.display = 'block';
            result.innerHTML = 'æ­£åœ¨è¿è¡Œç»¼åˆæµ‹è¯•...';
            
            try {
                const response = await fetch('/api/speedtest');
                const data = await response.json();
                
                if (response.ok) {
                    result.innerHTML = `ç»¼åˆæµ‹è¯•ç»“æœ:
ä¸‹è½½é€Ÿåº¦: ${data.download_speed.toFixed(2)} MB/s
ä¸Šä¼ é€Ÿåº¦: ${data.upload_speed.toFixed(2)} MB/s
å»¶è¿Ÿ: ${data.latency}ms
æµ‹è¯•æ—¶é—´: ${data.timestamp}`;
                } else {
                    throw new Error(data.error || 'æµ‹è¯•å¤±è´¥');
                }
                
            } catch (error) {
                result.innerHTML = `æµ‹è¯•å¤±è´¥: ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'å¼€å§‹ç»¼åˆæµ‹è¯•';
            }
        }
    </script>
</body>
</html>